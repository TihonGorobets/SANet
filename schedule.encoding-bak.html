<!DOCTYPE html>
<html lang="pl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dziennikarstwo VI â€” Plan ZajÄ™Ä‡</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       DESIGN TOKENS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      /* brand */
      --clr-primary:      #2563EB;
      --clr-primary-soft: #DBEAFE;
      --clr-primary-mid:  #93C5FD;

      /* type badges */
      --clr-war:  #2563EB;   --clr-war-bg:  #EFF6FF;
      --clr-cw:   #059669;   --clr-cw-bg:   #ECFDF5;
      --clr-kw:   #D97706;   --clr-kw-bg:   #FFFBEB;
      --clr-lab:  #7C3AED;   --clr-lab-bg:  #F5F3FF;

      /* surfaces */
      --bg:              #F0F4F8;
      --surface:         #FFFFFF;
      --surface-raised:  #FFFFFF;
      --border:          #E2E8F0;

      /* text */
      --text-primary:    #0F172A;
      --text-secondary:  #475569;
      --text-muted:      #94A3B8;

      /* misc */
      --radius-card:  16px;
      --radius-badge: 8px;
      --shadow-card:  0 2px 8px rgba(15,23,42,.06), 0 1px 2px rgba(15,23,42,.04);
      --shadow-hover:  0 8px 24px rgba(37,99,235,.12), 0 2px 6px rgba(15,23,42,.06);
      --transition:   .22s cubic-bezier(.4,0,.2,1);
    }

    [data-theme="dark"] {
      --clr-primary:      #60A5FA;
      --clr-primary-soft: #1E3A5F;
      --clr-primary-mid:  #3B82F6;

      --clr-war-bg:  #1E305A;
      --clr-cw-bg:   #0F2D24;
      --clr-kw-bg:   #2D1F08;
      --clr-lab-bg:  #1E0F3D;

      --bg:              #0B1120;
      --surface:         #111827;
      --surface-raised:  #1A2236;
      --border:          #1F2D42;

      --text-primary:    #F1F5F9;
      --text-secondary:  #94A3B8;
      --text-muted:      #475569;

      --shadow-card:  0 2px 8px rgba(0,0,0,.4), 0 1px 2px rgba(0,0,0,.3);
      --shadow-hover:  0 8px 24px rgba(96,165,250,.15), 0 2px 6px rgba(0,0,0,.35);
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       RESET & BASE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background var(--transition), color var(--transition);
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       LAYOUT WRAPPER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-wrapper {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px 80px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       HEADER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .site-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 36px 0 28px;
      gap: 16px;
    }

    .header-brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .header-eyebrow {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--clr-primary);
      opacity: .85;
    }

    .header-title {
      font-size: clamp(22px, 5vw, 32px);
      font-weight: 700;
      letter-spacing: -.02em;
      color: var(--text-primary);
      line-height: 1.15;
    }

    .header-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 400;
      margin-top: 2px;
    }

    /* dark-mode toggle */
    .theme-toggle {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }

    .theme-toggle-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .toggle-track {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--border);
      border-radius: 100px;
      transition: background var(--transition);
    }

    .toggle-track.active { background: var(--clr-primary); }

    .toggle-thumb {
      position: absolute;
      top: 3px; left: 3px;
      width: 18px; height: 18px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 4px rgba(0,0,0,.2);
      transition: left var(--transition);
    }

    .toggle-track.active .toggle-thumb { left: 23px; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       STATS BAR
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .stat-chip {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      padding: 6px 14px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition), border var(--transition);
    }

    .stat-chip .dot {
      width: 7px; height: 7px;
      border-radius: 50%;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       DAY FILTER PILLS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .day-filter {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 32px;
      align-items: center;
    }

    .day-filter-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-right: 4px;
    }

    .day-pill {
      padding: 7px 18px;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: 1.5px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      transition: all var(--transition);
      white-space: nowrap;
    }

    .day-pill:hover {
      border-color: var(--clr-primary-mid);
      color: var(--clr-primary);
      background: var(--clr-primary-soft);
    }

    .day-pill.active {
      background: var(--clr-primary);
      border-color: var(--clr-primary);
      color: #fff;
      box-shadow: 0 2px 10px rgba(37,99,235,.3);
    }

    .day-pill.today {
      border-color: var(--clr-primary-mid);
    }

    .day-pill.today::after {
      content: '';
      display: inline-block;
      width: 5px; height: 5px;
      border-radius: 50%;
      background: #22C55E;
      margin-left: 6px;
      vertical-align: middle;
      position: relative;
      top: -1px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       DAY SECTION
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .day-section {
      margin-bottom: 40px;
      transition: opacity .25s ease;
    }

    .day-section.hidden {
      display: none;
    }

    .day-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .day-name {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -.02em;
      color: var(--text-primary);
    }

    .day-name-pl {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: .04em;
    }

    .day-badge-today {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: #fff;
      background: #22C55E;
      border-radius: 100px;
      padding: 3px 10px;
    }

    .day-divider {
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* empty day */
    .day-empty {
      background: var(--surface);
      border: 1.5px dashed var(--border);
      border-radius: var(--radius-card);
      padding: 24px 20px;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      text-align: center;
      letter-spacing: .02em;
    }

    /* cards container */
    .cards-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CLASS CARD
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .class-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-card);
      padding: 20px 22px;
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0 20px;
      box-shadow: var(--shadow-card);
      transition: transform var(--transition), box-shadow var(--transition),
                  background var(--transition), border var(--transition);
      cursor: default;
      position: relative;
      overflow: hidden;
    }

    .class-card::before {
      content: '';
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 4px;
      border-radius: 4px 0 0 4px;
      background: var(--card-accent, var(--clr-primary));
    }

    .class-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
      border-color: var(--clr-primary-mid);
    }

    /* type variants */
    .class-card[data-type="war"] { --card-accent: var(--clr-war); }
    .class-card[data-type="cw"]  { --card-accent: var(--clr-cw); }
    .class-card[data-type="kw"]  { --card-accent: var(--clr-kw); }
    .class-card[data-type="lab"] { --card-accent: var(--clr-lab); }

    /* TIME COLUMN */
    .card-time {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 68px;
      padding-top: 2px;
    }

    .time-start {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -.02em;
      line-height: 1;
    }

    .time-sep {
      width: 2px;
      flex: 1;
      min-height: 14px;
      max-height: 28px;
      background: var(--border);
      margin: 5px 0;
      border-radius: 1px;
    }

    .time-end {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: -.01em;
      line-height: 1;
    }

    .time-duration {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-muted);
      margin-top: 5px;
      background: var(--bg);
      padding: 2px 7px;
      border-radius: 100px;
    }

    /* CONTENT COLUMN */
    .card-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .card-subject {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -.01em;
      line-height: 1.3;
    }

    .type-badge {
      flex-shrink: 0;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: var(--radius-badge);
      white-space: nowrap;
    }

    .type-badge.war { color: var(--clr-war); background: var(--clr-war-bg); }
    .type-badge.cw  { color: var(--clr-cw);  background: var(--clr-cw-bg); }
    .type-badge.kw  { color: var(--clr-kw);  background: var(--clr-kw-bg); }
    .type-badge.lab { color: var(--clr-lab); background: var(--clr-lab-bg); }

    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12.5px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .meta-item svg {
      flex-shrink: 0;
      opacity: .65;
    }

    .meta-item strong {
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Dates section */
    .card-dates {
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .dates-toggle {
      font-size: 11px;
      font-weight: 600;
      color: var(--clr-primary);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      letter-spacing: .03em;
      user-select: none;
      transition: opacity var(--transition);
    }

    .dates-toggle:hover { opacity: .75; }

    .dates-toggle .arrow {
      display: inline-block;
      transition: transform var(--transition);
    }

    .dates-toggle.open .arrow { transform: rotate(90deg); }

    .dates-grid {
      display: none;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 8px;
    }

    .dates-grid.visible { display: flex; }

    .date-chip {
      font-size: 11px;
      font-weight: 500;
      padding: 3px 9px;
      border-radius: 100px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      transition: background var(--transition), border var(--transition);
    }

    .date-chip.today-date {
      background: var(--clr-primary);
      border-color: var(--clr-primary);
      color: #fff;
      font-weight: 700;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       LEGEND
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .legend {
      margin-top: 40px;
      padding: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-card);
      display: flex;
      flex-wrap: wrap;
      gap: 14px 24px;
      align-items: center;
    }

    .legend-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--text-muted);
      width: 100%;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .legend-dot {
      width: 10px; height: 10px;
      border-radius: 3px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       FOOTER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .site-footer {
      margin-top: 48px;
      text-align: center;
      font-size: 11.5px;
      color: var(--text-muted);
      font-weight: 400;
      line-height: 1.7;
    }

    .site-footer a {
      color: var(--clr-primary);
      text-decoration: none;
      font-weight: 500;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       RESPONSIVE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 540px) {
      .class-card {
        grid-template-columns: 1fr;
        gap: 14px 0;
        padding: 18px 16px;
      }

      .card-time {
        flex-direction: row;
        align-items: center;
        gap: 6px;
        min-width: unset;
      }

      .time-sep {
        width: 18px; height: 2px;
        min-height: unset; max-height: unset;
        margin: 0;
      }

      .time-end { font-size: 14px; color: var(--text-secondary); }

      .time-duration { margin-top: 0; margin-left: 8px; }

      .card-top { flex-direction: column; }

      .site-header { flex-wrap: wrap; }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       WHITEBOARD â€” OPEN BUTTON
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .wb-open-btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 9px 18px;
      background: var(--clr-primary);
      color: #fff;
      border: none;
      border-radius: 100px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      letter-spacing: -.01em;
      box-shadow: 0 2px 10px rgba(37,99,235,.3);
      transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
      white-space: nowrap;
    }
    .wb-open-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 18px rgba(37,99,235,.42);
    }
    .wb-open-btn svg { width:15px; height:15px; flex-shrink:0; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       WHITEBOARD â€” OVERLAY
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .wb-overlay {
      position: fixed;
      inset: 0;
      z-index: 9000;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      transform: translateX(100%);
      transition: transform .38s cubic-bezier(.4,0,.2,1);
    }
    .wb-overlay.open { transform: translateX(0); }

    /* TOP BAR */
    .wb-topbar {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 0 14px;
      height: 54px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      z-index: 10;
      overflow-x: auto;
      overflow-y: hidden;
    }
    .wb-topbar::-webkit-scrollbar { display: none; }

    .wb-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -.02em;
      white-space: nowrap;
      margin-right: 4px;
    }

    .wb-sep {
      width: 1px; height: 24px;
      background: var(--border);
      flex-shrink: 0;
    }

    .wb-tool-group { display:flex; align-items:center; gap:2px; }

    .wb-tool-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px; height: 34px;
      border: 1.5px solid transparent;
      border-radius: 9px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      font-family: inherit;
      font-size: 11px;
      font-weight: 700;
      transition: all var(--transition);
      padding: 0;
      position: relative;
      flex-shrink: 0;
    }
    .wb-tool-btn:hover { background: var(--bg); color: var(--text-primary); }
    .wb-tool-btn.active {
      background: var(--clr-primary-soft);
      border-color: var(--clr-primary-mid);
      color: var(--clr-primary);
    }
    .wb-tool-btn svg { width:16px; height:16px; flex-shrink:0; }

    .wb-tooltip {
      position: absolute;
      top: calc(100% + 7px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--text-primary);
      color: var(--bg);
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity .14s ease;
      font-weight: 600;
      z-index: 100;
    }
    .wb-tool-btn:hover .wb-tooltip { opacity: 1; }

    .wb-color-swatch {
      width: 26px; height: 26px;
      border-radius: 50%;
      border: 2.5px solid var(--border);
      cursor: pointer;
      flex-shrink: 0;
      transition: border-color var(--transition), transform var(--transition);
    }
    .wb-color-swatch:hover { border-color: var(--clr-primary); transform: scale(1.12); }

    .wb-size-group { display:flex; align-items:center; gap:5px; }
    .wb-size-label { font-size:10px; font-weight:600; color:var(--text-muted); white-space:nowrap; }
    .wb-size-input { width:72px; height:4px; accent-color:var(--clr-primary); cursor:pointer; }
    .wb-size-val { font-size:11px; font-weight:700; color:var(--text-secondary); min-width:16px; }

    .wb-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 6px 12px;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      background: var(--surface);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 11.5px;
      font-weight: 600;
      font-family: inherit;
      white-space: nowrap;
      transition: all var(--transition);
      flex-shrink: 0;
    }
    .wb-action-btn:hover { border-color:var(--clr-primary-mid); color:var(--clr-primary); background:var(--clr-primary-soft); }
    .wb-action-btn:disabled { opacity:.35; cursor:not-allowed; }
    .wb-action-btn:disabled:hover { border-color:var(--border); color:var(--text-secondary); background:var(--surface); }
    .wb-action-btn.danger:hover { border-color:#FCA5A5; color:#EF4444; background:#FEF2F2; }
    .wb-action-btn svg { width:14px; height:14px; flex-shrink:0; }

    .wb-close-btn {
      display: inline-flex; align-items:center; justify-content:center;
      width:34px; height:34px; border-radius:9px;
      border:1.5px solid var(--border);
      background:var(--surface); color:var(--text-secondary);
      cursor:pointer; transition:all var(--transition); flex-shrink:0;
    }
    .wb-close-btn:hover { border-color:#FCA5A5; color:#EF4444; background:#FEF2F2; }
    .wb-ml-auto { margin-left:auto; display:flex; align-items:center; gap:5px; }

    /* CANVAS AREA */
    .wb-canvas-area {
      flex: 1;
      position: relative;
      overflow: hidden;
      background-color: var(--bg);
      background-image:
        linear-gradient(rgba(100,116,139,.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(100,116,139,.1) 1px, transparent 1px);
      background-size: 40px 40px;
      background-position: 0 0;
      cursor: crosshair;
    }
    [data-theme="dark"] .wb-canvas-area {
      background-image:
        linear-gradient(rgba(148,163,184,.07) 1px, transparent 1px),
        linear-gradient(90deg, rgba(148,163,184,.07) 1px, transparent 1px);
    }
    #wbCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      touch-action: none;
    }
    .wb-canvas-area.cur-pan    { cursor: grab; }
    .wb-canvas-area.cur-panning{ cursor: grabbing; }
    .wb-canvas-area.cur-eraser { cursor: cell; }
    .wb-canvas-area.cur-text   { cursor: text; }
    .wb-canvas-area.cur-select { cursor: default; }
    .wb-canvas-area.cur-cross  { cursor: crosshair; }

    /* STICKY LAYER */
    #stickyLayer {
      position: absolute;
      top: 0; left: 0;
      width: 0; height: 0;
      transform-origin: 0 0;
      pointer-events: none;
      overflow: visible;
    }

    /* â”€â”€ STICKY NOTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sticky-note {
      position: absolute;
      min-width: 150px; min-height: 110px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      pointer-events: all;
      user-select: none;
      box-shadow: 0 4px 14px rgba(0,0,0,.13), 0 1px 4px rgba(0,0,0,.07);
      transition: box-shadow .18s ease;
    }
    .sticky-note:hover { box-shadow: 0 8px 24px rgba(0,0,0,.18), 0 2px 6px rgba(0,0,0,.1); }

    .sticky-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 8px 5px;
      border-radius: 12px 12px 0 0;
      cursor: grab;
      flex-shrink: 0;
    }
    .sticky-header:active { cursor: grabbing; }

    .sticky-color-dots { display:flex; gap:4px; }
    .sticky-color-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      cursor: pointer;
      border: 1.5px solid rgba(0,0,0,.13);
      flex-shrink: 0;
      transition: transform .12s ease;
    }
    .sticky-color-dot:hover { transform: scale(1.3); }

    .sticky-del-btn {
      width:20px; height:20px; border-radius:6px;
      border:none; background:rgba(0,0,0,.1); color:rgba(0,0,0,.55);
      cursor:pointer; font-size:14px; line-height:1;
      display:flex; align-items:center; justify-content:center;
      padding:0; transition:background .12s ease;
    }
    .sticky-del-btn:hover { background:rgba(239,68,68,.22); color:#DC2626; }

    .sticky-text {
      flex: 1; resize: none; border: none;
      background: transparent; padding: 5px 10px 8px;
      font-family: inherit; font-size: 13px; font-weight: 400;
      line-height: 1.55; color: rgba(0,0,0,.75);
      outline: none; overflow-y: auto;
      border-radius: 0 0 12px 12px;
    }
    .sticky-text::placeholder { color:rgba(0,0,0,.32); }

    .sticky-resize {
      position: absolute;
      bottom: -4px; right: -4px;
      width: 13px; height: 13px;
      border-radius: 50%;
      background: rgba(0,0,0,.18);
      cursor: se-resize;
      pointer-events: all;
    }

    /* STATUS BAR */
    .wb-statusbar {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 16px;
      height: 28px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .wb-status-item { font-size:10.5px; font-weight:500; color:var(--text-muted); }
    .wb-status-item strong { color:var(--text-secondary); font-weight:700; }
    .wb-kb {
      display:inline-block;
      background:var(--bg); border:1px solid var(--border);
      border-radius:4px; padding:1px 5px;
      font-size:9.5px; font-weight:600; color:var(--text-secondary);
    }
    .wb-hints { margin-left:auto; font-size:10px; color:var(--text-muted); }

    /* PALETTE POPUP */
    .wb-palette {
      position: fixed;
      z-index: 9999;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 8px 28px rgba(0,0,0,.16);
      display: none;
      flex-direction: column;
      gap: 10px;
    }
    .wb-palette.open { display:flex; }
    .wb-palette-grid { display:grid; grid-template-columns:repeat(7,22px); gap:5px; }
    .wb-pal-swatch {
      width:22px; height:22px; border-radius:50%;
      cursor:pointer; border:2px solid transparent;
      transition:transform .12s ease, border-color .12s ease;
    }
    .wb-pal-swatch:hover { transform:scale(1.2); }
    .wb-pal-swatch.sel { border-color:var(--text-primary); }
    .wb-pal-custom {
      display:flex; align-items:center; gap:8px;
      font-size:11px; font-weight:500; color:var(--text-secondary);
    }
    .wb-pal-custom input[type=color] {
      width:26px; height:26px; border:none;
      padding:0; border-radius:50%; cursor:pointer; background:none;
    }

    /* TOAST */
    .wb-toast {
      position: fixed;
      bottom: 44px; left: 50%;
      transform: translateX(-50%) translateY(16px);
      background: var(--text-primary); color: var(--bg);
      font-size: 12.5px; font-weight: 600;
      padding: 8px 20px; border-radius: 100px;
      z-index: 99999; opacity: 0;
      transition: opacity .22s ease, transform .22s ease;
      pointer-events: none; white-space: nowrap;
    }
    .wb-toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

    @media (max-width:600px) {
      .wb-topbar { gap:4px; padding:0 8px; }
      .wb-action-btn span { display:none; }
      .wb-action-btn { padding:6px 8px; }
      .wb-size-label { display:none; }
      .wb-size-input { width:50px; }
      .wb-hints { display:none; }
    }
  </style>
</head>
<body>

<div class="page-wrapper">

  <!-- â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="site-header">
    <div class="header-brand">
      <span class="header-eyebrow">SpoÅ‚eczna Akademia Nauk Â· Warszawa</span>
      <h1 class="header-title">Dziennikarstwo VI</h1>
      <p class="header-subtitle">Plan zajÄ™Ä‡ &mdash; studia stacjonarne &bull; rok akad. 2025/26</p>
    </div>
    <div class="header-actions">
      <button class="wb-open-btn" id="wbOpenBtn" aria-label="OtwÃ³rz tablicÄ™">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        Whiteboard
      </button>
      <div class="theme-toggle" id="themeToggle" role="button" aria-label="PrzeÅ‚Ä…cz tryb ciemny" tabindex="0">
        <span class="theme-toggle-label" id="themeLabel">Jasny</span>
        <div class="toggle-track" id="toggleTrack">
          <div class="toggle-thumb"></div>
        </div>
      </div>
    </div>
  </header>

  <!-- â”€â”€ STATS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="stats-bar">
    <div class="stat-chip"><span class="dot" style="background:#2563EB"></span>6 przedmiotÃ³w</div>
    <div class="stat-chip"><span class="dot" style="background:#22C55E"></span>3 dni dydaktyczne</div>
    <div class="stat-chip"><span class="dot" style="background:#7C3AED"></span>Sem. letni 2025/26</div>
    <div class="stat-chip"><span class="dot" style="background:#F59E0B"></span>Åucka 11, Warszawa</div>
  </div>

  <!-- â”€â”€ DAY FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="day-filter" role="group" aria-label="Filtruj wedÅ‚ug dnia">
    <span class="day-filter-label">Filtruj:</span>
    <button class="day-pill active" data-filter="all">Wszystkie</button>
    <button class="day-pill" data-filter="pn">PoniedziaÅ‚ek</button>
    <button class="day-pill" data-filter="wt">Wtorek</button>
    <button class="day-pill" data-filter="sr">Åšroda</button>
    <button class="day-pill" data-filter="czw">Czwartek</button>
    <button class="day-pill today" data-filter="pi">PiÄ…tek</button>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SCHEDULE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

  <!-- â”€â”€ MONDAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section class="day-section" data-day="pn" id="day-pn">
    <div class="day-header">
      <span class="day-name">PoniedziaÅ‚ek</span>
      <span class="day-name-pl">Monday</span>
      <div class="day-divider"></div>
    </div>
    <div class="day-empty">Brak zajÄ™Ä‡ w tym dniu</div>
  </section>

  <!-- â”€â”€ TUESDAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section class="day-section" data-day="wt" id="day-wt">
    <div class="day-header">
      <span class="day-name">Wtorek</span>
      <span class="day-name-pl">Tuesday</span>
      <div class="day-divider"></div>
    </div>
    <div class="day-empty">Brak zajÄ™Ä‡ w tym dniu</div>
  </section>

  <!-- â”€â”€ WEDNESDAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section class="day-section" data-day="sr" id="day-sr">
    <div class="day-header">
      <span class="day-name">Åšroda</span>
      <span class="day-name-pl">Wednesday</span>
      <div class="day-divider"></div>
    </div>
    <div class="cards-list">

      <!-- CARD 1 -->
      <article class="class-card" data-type="war">
        <div class="card-time">
          <span class="time-start">9:45</span>
          <div class="time-sep"></div>
          <span class="time-end">11:15</span>
          <span class="time-duration">90 min</span>
        </div>
        <div class="card-content">
          <div class="card-top">
            <h3 class="card-subject">Formy radiowe</h3>
            <span class="type-badge war">Warsztaty</span>
          </div>
          <div class="card-meta">
            <span class="meta-item">
              <!-- person icon -->
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              <strong>Malinowski, PaweÅ‚</strong>
            </span>
            <span class="meta-item">
              <!-- room icon -->
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              Sala <strong>223</strong>
            </span>
            <span class="meta-item">
              <!-- code icon -->
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
              ZS:D_Formy radiowe
            </span>
          </div>
          <div class="card-dates">
            <span class="dates-toggle" data-target="dates-sr1">
              <span class="arrow">â€º</span> PokaÅ¼ terminy (12 zajÄ™Ä‡)
            </span>
            <div class="dates-grid" id="dates-sr1">
              <span class="date-chip">4.03</span><span class="date-chip">11.03</span><span class="date-chip">18.03</span><span class="date-chip">25.03</span><span class="date-chip">8.04</span><span class="date-chip">15.04</span><span class="date-chip">22.04</span><span class="date-chip">29.04</span><span class="date-chip">6.05</span><span class="date-chip">13.05</span><span class="date-chip">20.05</span><span class="date-chip">27.05</span>
            </div>
          </div>
        </div>
      </article>

      <!-- CARD 2 -->
      <article class="class-card" data-type="war">
        <div class="card-time">
          <span class="time-start">11:30</span>
          <div class="time-sep"></div>
          <span class="time-end">13:00</span>
          <span class="time-duration">90 min</span>
        </div>
        <div class="card-content">
          <div class="card-top">
            <h3 class="card-subject">Formy telewizyjne</h3>
            <span class="type-badge war">Warsztaty</span>
          </div>
          <div class="card-meta">
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              <strong>Dudkiewicz, JÄ™drzej</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              Sala <strong>221</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
              ZS:D_Formy telewizyjne
            </span>
          </div>
          <div class="card-dates">
            <span class="dates-toggle" data-target="dates-sr2">
              <span class="arrow">â€º</span> PokaÅ¼ terminy (12 zajÄ™Ä‡)
            </span>
            <div class="dates-grid" id="dates-sr2">
              <span class="date-chip">4.03</span><span class="date-chip">11.03</span><span class="date-chip">18.03</span><span class="date-chip">25.03</span><span class="date-chip">8.04</span><span class="date-chip">15.04</span><span class="date-chip">22.04</span><span class="date-chip">29.04</span><span class="date-chip">6.05</span><span class="date-chip">13.05</span><span class="date-chip">20.05</span><span class="date-chip">27.05</span>
            </div>
          </div>
        </div>
      </article>

      <!-- CARD 3 -->
      <article class="class-card" data-type="cw">
        <div class="card-time">
          <span class="time-start">13:15</span>
          <div class="time-sep"></div>
          <span class="time-end">14:45</span>
          <span class="time-duration">90 min</span>
        </div>
        <div class="card-content">
          <div class="card-top">
            <h3 class="card-subject">WstÄ™p do kreatywnego pisania</h3>
            <span class="type-badge cw">Ä†wiczenia</span>
          </div>
          <div class="card-meta">
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              <strong>Sieczkowski, Grzegorz</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              Sala <strong>207</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
              ZS:D_WstÄ™p do kreatywnego pisania
            </span>
          </div>
          <div class="card-dates">
            <span class="dates-toggle" data-target="dates-sr3">
              <span class="arrow">â€º</span> PokaÅ¼ terminy (12 zajÄ™Ä‡)
            </span>
            <div class="dates-grid" id="dates-sr3">
              <span class="date-chip">4.03</span><span class="date-chip">11.03</span><span class="date-chip">18.03</span><span class="date-chip">25.03</span><span class="date-chip">8.04</span><span class="date-chip">15.04</span><span class="date-chip">22.04</span><span class="date-chip">29.04</span><span class="date-chip">6.05</span><span class="date-chip">13.05</span><span class="date-chip">20.05</span><span class="date-chip">27.05</span>
            </div>
          </div>
        </div>
      </article>

      <!-- CARD 4 -->
      <article class="class-card" data-type="kw">
        <div class="card-time">
          <span class="time-start">15:00</span>
          <div class="time-sep"></div>
          <span class="time-end">16:30</span>
          <span class="time-duration">90 min</span>
        </div>
        <div class="card-content">
          <div class="card-top">
            <h3 class="card-subject">Socjologia kultury i mediÃ³w</h3>
            <span class="type-badge kw">Konwersatorium</span>
          </div>
          <div class="card-meta">
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              <strong>HerudziÅ„ski, Tomasz</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              Sala <strong>207</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
              Socjologia kultury i mediÃ³w
            </span>
          </div>
          <div class="card-dates">
            <span class="dates-toggle" data-target="dates-sr4">
              <span class="arrow">â€º</span> PokaÅ¼ terminy (12 zajÄ™Ä‡)
            </span>
            <div class="dates-grid" id="dates-sr4">
              <span class="date-chip">4.03</span><span class="date-chip">11.03</span><span class="date-chip">18.03</span><span class="date-chip">25.03</span><span class="date-chip">8.04</span><span class="date-chip">15.04</span><span class="date-chip">22.04</span><span class="date-chip">29.04</span><span class="date-chip">6.05</span><span class="date-chip">13.05</span><span class="date-chip">20.05</span><span class="date-chip">27.05</span>
            </div>
          </div>
        </div>
      </article>

    </div><!-- /cards-list -->
  </section>

  <!-- â”€â”€ THURSDAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section class="day-section" data-day="czw" id="day-czw">
    <div class="day-header">
      <span class="day-name">Czwartek</span>
      <span class="day-name-pl">Thursday</span>
      <div class="day-divider"></div>
    </div>
    <div class="cards-list">

      <!-- CARD 1 (double slot) -->
      <article class="class-card" data-type="war">
        <div class="card-time">
          <span class="time-start">11:30</span>
          <div class="time-sep" style="min-height:28px"></div>
          <span class="time-end">14:45</span>
          <span class="time-duration">3 Ã— 45 min</span>
        </div>
        <div class="card-content">
          <div class="card-top">
            <h3 class="card-subject">Tech. dziennikarstwa w nowych mediach</h3>
            <span class="type-badge war">Warsztaty</span>
          </div>
          <div class="card-meta">
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              <strong>Kot, Jan</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              Sala <strong>207</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
              ZS:D_Tech. dziennikarstwa w nowych mediach
            </span>
          </div>
          <div class="card-dates">
            <span class="dates-toggle" data-target="dates-czw1">
              <span class="arrow">â€º</span> PokaÅ¼ terminy (6 zajÄ™Ä‡)
            </span>
            <div class="dates-grid" id="dates-czw1">
              <span class="date-chip">5.03</span><span class="date-chip">19.03</span><span class="date-chip">9.04</span><span class="date-chip">23.04</span><span class="date-chip">7.05</span><span class="date-chip">21.05</span>
            </div>
          </div>
        </div>
      </article>

    </div>
  </section>

  <!-- â”€â”€ FRIDAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section class="day-section" data-day="pi" id="day-pi">
    <div class="day-header">
      <span class="day-name">PiÄ…tek</span>
      <span class="day-name-pl">Friday</span>
      <span class="day-badge-today">Dzisiaj</span>
      <div class="day-divider"></div>
    </div>
    <div class="cards-list">

      <!-- CARD 1 (double slot) -->
      <article class="class-card" data-type="lab">
        <div class="card-time">
          <span class="time-start">8:00</span>
          <div class="time-sep" style="min-height:28px"></div>
          <span class="time-end">11:15</span>
          <span class="time-duration">3 Ã— 45 min</span>
        </div>
        <div class="card-content">
          <div class="card-top">
            <h3 class="card-subject">Edycja fotografii dla dziennikarzy</h3>
            <span class="type-badge lab">Laboratorium</span>
          </div>
          <div class="card-meta">
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              <strong>Korab, Tadeusz</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              Sala <strong>521</strong>
            </span>
            <span class="meta-item">
              <svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
              ZS:D_Edycja fotografii dla dziennikarzy
            </span>
          </div>
          <div class="card-dates">
            <span class="dates-toggle" data-target="dates-pi1">
              <span class="arrow">â€º</span> PokaÅ¼ terminy (6 zajÄ™Ä‡)
            </span>
            <div class="dates-grid" id="dates-pi1">
              <span class="date-chip">6.03</span><span class="date-chip">20.03</span><span class="date-chip">10.04</span><span class="date-chip">24.04</span><span class="date-chip">8.05</span><span class="date-chip">22.05</span>
            </div>
          </div>
        </div>
      </article>

    </div>
  </section>

  <!-- â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="legend">
    <span class="legend-title">Legenda typÃ³w zajÄ™Ä‡</span>
    <div class="legend-item"><span class="legend-dot" style="background:#2563EB"></span>Warsztaty (war)</div>
    <div class="legend-item"><span class="legend-dot" style="background:#059669"></span>Ä†wiczenia (Ä‡w)</div>
    <div class="legend-item"><span class="legend-dot" style="background:#D97706"></span>Konwersatorium (kw)</div>
    <div class="legend-item"><span class="legend-dot" style="background:#7C3AED"></span>Laboratorium (lab)</div>
  </div>

  <!-- â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <footer class="site-footer">
    <p>Plan wygenerowany: <strong>20.02.2026</strong> &bull; Å¹rÃ³dÅ‚o: <a href="https://san.edu.pl/plany-zajec-warszawa/studia-stacjonarne" target="_blank">san.edu.pl</a></p>
    <p style="margin-top:4px">Prosimy o sprawdzanie planu przed zajÄ™ciami. Plan oraz sale mogÄ… ulec zmianie.</p>
  </footer>

</div><!-- /page-wrapper -->

<script>
  /* â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const html         = document.documentElement;
  const themeToggle  = document.getElementById('themeToggle');
  const toggleTrack  = document.getElementById('toggleTrack');
  const themeLabel   = document.getElementById('themeLabel');

  function setTheme(dark) {
    html.setAttribute('data-theme', dark ? 'dark' : 'light');
    toggleTrack.classList.toggle('active', dark);
    themeLabel.textContent = dark ? 'Ciemny' : 'Jasny';
    localStorage.setItem('san-theme', dark ? 'dark' : 'light');
  }

  // load saved preference
  const saved = localStorage.getItem('san-theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  setTheme(saved ? saved === 'dark' : prefersDark);

  themeToggle.addEventListener('click', () => {
    setTheme(html.getAttribute('data-theme') !== 'dark');
  });
  themeToggle.addEventListener('keydown', e => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      themeToggle.click();
    }
  });

  /* â”€â”€ DAY FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const pills    = document.querySelectorAll('.day-pill');
  const sections = document.querySelectorAll('.day-section');

  pills.forEach(pill => {
    pill.addEventListener('click', () => {
      pills.forEach(p => p.classList.remove('active'));
      pill.classList.add('active');

      const filter = pill.dataset.filter;
      sections.forEach(sec => {
        if (filter === 'all' || sec.dataset.day === filter) {
          sec.classList.remove('hidden');
        } else {
          sec.classList.add('hidden');
        }
      });

      // scroll to section
      if (filter !== 'all') {
        const target = document.getElementById('day-' + filter);
        if (target) {
          setTimeout(() => target.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
        }
      }
    });
  });

  /* â”€â”€ DATES TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  document.querySelectorAll('.dates-toggle').forEach(toggle => {
    toggle.addEventListener('click', () => {
      const targetId = toggle.dataset.target;
      const grid     = document.getElementById(targetId);
      const isOpen   = grid.classList.contains('visible');

      grid.classList.toggle('visible', !isOpen);
      toggle.classList.toggle('open', !isOpen);
      toggle.innerHTML = isOpen
        ? `<span class="arrow">â€º</span> PokaÅ¼ terminy (${grid.children.length} zajÄ™Ä‡)`
        : `<span class="arrow">â€º</span> Ukryj terminy`;
    });
  });

  /* â”€â”€ HIGHLIGHT TODAY'S DATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  // Current date: 20.02.2026 (Friday, Pi)
  // Mark today in all date grids if "20.02" appears - not in the data,
  // but mark the relevant Friday section as today
  // Today's date as "d.mm" â†’ "20.02" â€” not in any course dates (semester starts 4.03)
  // So we just highlight today's day section visually â€” already done via .day-badge-today

  /* â”€â”€ AUTO-SCROLL TO TODAY ON LOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  window.addEventListener('load', () => {
    const todaySection = document.getElementById('day-pi');
    if (todaySection) {
      setTimeout(() => {
        todaySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 400);
    }
  });
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     WHITEBOARD OVERLAY
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="wb-overlay" id="wbOverlay" role="dialog" aria-label="Whiteboard">

  <!-- TOP BAR -->
  <div class="wb-topbar" id="wbTopbar">
    <span class="wb-title">âœï¸ Whiteboard</span>
    <div class="wb-sep"></div>

    <!-- Drawing tools -->
    <div class="wb-tool-group">
      <button class="wb-tool-btn active" data-tool="select">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3l14 9-7 1-4 7L5 3z"/></svg>
        <span class="wb-tooltip">Select (V)</span>
      </button>
      <button class="wb-tool-btn" data-tool="pen">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        <span class="wb-tooltip">Pen (P)</span>
      </button>
      <button class="wb-tool-btn" data-tool="highlighter">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
        <span class="wb-tooltip">Highlighter (H)</span>
      </button>
      <button class="wb-tool-btn" data-tool="eraser">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16l10-10 7 7-1.5 1.5"/><path d="M6 18L17 7"/></svg>
        <span class="wb-tooltip">Eraser (E)</span>
      </button>
    </div>
    <div class="wb-sep"></div>

    <!-- Shape tools -->
    <div class="wb-tool-group">
      <button class="wb-tool-btn" data-tool="line">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="19" x2="19" y2="5"/></svg>
        <span class="wb-tooltip">Line (L)</span>
      </button>
      <button class="wb-tool-btn" data-tool="rect">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
        <span class="wb-tooltip">Rectangle (R)</span>
      </button>
      <button class="wb-tool-btn" data-tool="circle">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg>
        <span class="wb-tooltip">Circle (C)</span>
      </button>
      <button class="wb-tool-btn" data-tool="text">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
        <span class="wb-tooltip">Text (T)</span>
      </button>
    </div>
    <div class="wb-sep"></div>

    <!-- Color -->
    <button class="wb-color-swatch" id="wbColorSwatch" style="background:#2563EB" title="Color (K)"></button>

    <!-- Size -->
    <div class="wb-size-group">
      <span class="wb-size-label">Size</span>
      <input type="range" class="wb-size-input" id="wbSizeSlider" min="1" max="48" value="4" />
      <span class="wb-size-val" id="wbSizeVal">4</span>
    </div>
    <div class="wb-sep"></div>

    <!-- Sticky note -->
    <button class="wb-action-btn" id="wbAddSticky" title="Add Sticky Note (N)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h8"/><path d="M14 2l6 6v8a2 2 0 01-2 2"/><path d="M14 2v6h6"/><line x1="8" y1="13" x2="13" y2="13"/><line x1="8" y1="17" x2="13" y2="17"/></svg>
      <span>Sticky</span>
    </button>

    <!-- Right-side actions -->
    <div class="wb-ml-auto">
      <button class="wb-action-btn" id="wbUndo" title="Undo (Ctrl+Z)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/></svg>
        <span>Undo</span>
      </button>
      <button class="wb-action-btn" id="wbRedo" title="Redo (Ctrl+Y / Ctrl+Shift+Z)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 019-9 9 9 0 016 2.3L21 13"/></svg>
        <span>Redo</span>
      </button>
      <div class="wb-sep"></div>
      <button class="wb-action-btn" id="wbSave" title="Save (Ctrl+S)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        <span>Save</span>
      </button>
      <button class="wb-action-btn" id="wbExport" title="Export PNG (Ctrl+E)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        <span>Export</span>
      </button>
      <button class="wb-action-btn danger" id="wbClear" title="Clear Board">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M9 6V4h6v2"/></svg>
        <span>Clear</span>
      </button>
      <div class="wb-sep"></div>
      <button class="wb-close-btn" id="wbCloseBtn" title="Close (Esc)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
  </div>

  <!-- CANVAS AREA -->
  <div class="wb-canvas-area" id="wbCanvasArea">
    <canvas id="wbCanvas"></canvas>
    <div id="stickyLayer"></div>
  </div>

  <!-- STATUS BAR -->
  <div class="wb-statusbar">
    <span class="wb-status-item">Zoom: <strong id="wbZoomPct">100%</strong></span>
    <span class="wb-status-item">Tool: <strong id="wbToolName">Select</strong></span>
    <span class="wb-status-item">Stickies: <strong id="wbItemCount">0</strong></span>
    <span class="wb-hints">
      <span class="wb-kb">Space</span> pan &nbsp;
      <span class="wb-kb">Scroll</span> zoom &nbsp;
      <span class="wb-kb">Del</span> delete sticky &nbsp;
      <span class="wb-kb">Esc</span> close
    </span>
  </div>
</div>

<!-- Colour palette popup -->
<div class="wb-palette" id="wbPalette">
  <div class="wb-palette-grid" id="wbPaletteGrid"></div>
  <div class="wb-pal-custom">
    <span>Custom:</span>
    <input type="color" id="wbCustomColor" value="#2563EB" />
  </div>
</div>

<!-- Toast -->
<div class="wb-toast" id="wbToast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WHITEBOARD ENGINE v2 â€” Scene-Graph Architecture
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function () {
  'use strict';

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     DOM REFS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const overlay      = document.getElementById('wbOverlay');
  const canvasArea   = document.getElementById('wbCanvasArea');
  const canvas       = document.getElementById('wbCanvas');
  const ctx          = canvas.getContext('2d');
  const stickyLayer  = document.getElementById('stickyLayer');
  const openBtn      = document.getElementById('wbOpenBtn');
  const closeBtn     = document.getElementById('wbCloseBtn');
  const toolBtns     = document.querySelectorAll('.wb-tool-btn[data-tool]');
  const colorSwatch  = document.getElementById('wbColorSwatch');
  const sizeSlider   = document.getElementById('wbSizeSlider');
  const sizeVal      = document.getElementById('wbSizeVal');
  const addStickyBtn = document.getElementById('wbAddSticky');
  const undoBtn      = document.getElementById('wbUndo');
  const redoBtn      = document.getElementById('wbRedo');
  const saveBtn      = document.getElementById('wbSave');
  const exportBtn    = document.getElementById('wbExport');
  const clearBtn     = document.getElementById('wbClear');
  const zoomPctEl    = document.getElementById('wbZoomPct');
  const toolNameEl   = document.getElementById('wbToolName');
  const itemCountEl  = document.getElementById('wbItemCount');
  const toastEl      = document.getElementById('wbToast');
  const paletteEl    = document.getElementById('wbPalette');
  const paletteGrid  = document.getElementById('wbPaletteGrid');
  const customColorEl= document.getElementById('wbCustomColor');

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     CONSTANTS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const STORAGE_KEY = 'san-wb-v4';
  const MAX_HIST    = 60;
  const HANDLE_R    = 6;   // resize handle radius px (screen space)
  const HIT_THRESH  = 8;   // px tolerance for stroke hit-test
  const TOOL_LABELS = {
    select:'Select', pen:'Pen', highlighter:'Highlighter',
    eraser:'Eraser', line:'Line', rect:'Rectangle', circle:'Circle', text:'Text'
  };
  const STICKY_PALETTES = [
    { bg:'#FEF9C3', hd:'#FDE68A' },
    { bg:'#DCFCE7', hd:'#BBF7D0' },
    { bg:'#DBEAFE', hd:'#BFDBFE' },
    { bg:'#FCE7F3', hd:'#FBCFE8' },
    { bg:'#FFE4E6', hd:'#FECDD3' },
    { bg:'#F3E8FF', hd:'#E9D5FF' },
  ];
  const PAL_COLORS = [
    '#000000','#1E293B','#64748B','#94A3B8','#CBD5E1','#F1F5F9','#FFFFFF',
    '#EF4444','#F97316','#F59E0B','#EAB308','#84CC16','#22C55E','#10B981',
    '#06B6D4','#3B82F6','#6366F1','#8B5CF6','#A855F7','#EC4899','#F43F5E',
    '#2563EB','#059669','#D97706','#7C3AED','#0F172A','#DC2626','#FBBF24',
  ];

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     SCENE STATE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  /**
   * Scene objects â€” stored in world coordinates:
   *  stroke : { id, type:'stroke',    points:[{x,y}], color, width, opacity }
   *  line   : { id, type:'line',      x1,y1,x2,y2,   color, width }
   *  rect   : { id, type:'rect',      x,y,w,h,        color, width }
   *  circle : { id, type:'circle',    cx,cy,rx,ry,    color, width }
   *  text   : { id, type:'text',      x,y,content,    color, fontSize }
   */
  let objects  = [];
  let stickies = [];
  let objSeq   = 1;
  let stickySeq = 1;

  // Camera â€” single source of truth for viewport
  let cam = { x: 0, y: 0, scale: 1 };

  // Active tool + styling
  let tool      = 'select';
  let color     = '#2563EB';
  let brushSize = 4;

  // Selection
  let selectedId  = null;  // id of selected object or sticky
  let selIsSicky  = false;

  // Interaction state machine
  let iState = 'idle'; // idle | panning | drawing | dragging | resizing
  let panOrigin   = null;  // { mx,my,cx,cy }
  let drawOrigin  = null;  // world coords where stroke/shape started
  let liveStroke  = null;  // stroke being drawn (points[])
  let previewObj  = null;  // shape preview
  let moveOrigin  = null;  // { mx,my,ox,oy } for move-drag
  let resizeHandle= null;  // active resize handle id
  let resizeOrigin= null;  // { mx,my, snapshot of object }
  let spaceHeld   = false;

  // Inline text editing
  let textEditor  = null;  // <textarea> overlay element
  let editingId   = null;  // id of text object being edited

  // History
  let history = [], histIdx = -1;

  // Render scheduling
  let rafPending = false;

  // One-time init flag
  let initialized = false;
  let toastTimer  = null;

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     COORDINATE HELPERS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function s2w(sx, sy) {  // screen â†’ world
    return { x: (sx - cam.x) / cam.scale, y: (sy - cam.y) / cam.scale };
  }
  function w2s(wx, wy) {  // world â†’ screen
    return { x: wx * cam.scale + cam.x, y: wy * cam.scale + cam.y };
  }
  function evPos(e) {
    const r = canvasArea.getBoundingClientRect();
    const cl = e.touches ? e.touches[0] : e;
    return { sx: cl.clientX - r.left, sy: cl.clientY - r.top };
  }
  function evWorld(e) {
    const p = evPos(e);
    return s2w(p.sx, p.sy);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     CANVAS SETUP & RESIZE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function resizeCanvas() {
    canvas.width  = canvasArea.clientWidth;
    canvas.height = canvasArea.clientHeight;
    schedRender();
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     RENDER LOOP
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function schedRender() {
    if (rafPending) return;
    rafPending = true;
    requestAnimationFrame(render);
  }

  function render() {
    rafPending = false;
    const W = canvas.width, H = canvas.height;
    ctx.clearRect(0, 0, W, H);

    // Apply camera transform â€” everything drawn after this is in world space
    ctx.save();
    ctx.translate(cam.x, cam.y);
    ctx.scale(cam.scale, cam.scale);

    // Draw all scene objects
    for (const obj of objects) {
      drawObject(obj, false);
    }

    // Draw live stroke preview
    if (liveStroke && liveStroke.points.length > 1) {
      drawObject(liveStroke, false);
    }
    if (previewObj) {
      drawObject(previewObj, false);
    }

    ctx.restore();

    // Selection + handles drawn in screen space (no scale distortion)
    if (selectedId !== null && !selIsSicky) {
      drawSelectionOverlay();
    }

    // Sync sticky layer transform
    syncStickyLayer();
    updateZoomUI();
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     DRAW OBJECT
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function drawObject(obj, highlight) {
    ctx.save();
    ctx.globalCompositeOperation = 'source-over';
    switch (obj.type) {
      case 'stroke': drawStroke(obj, highlight); break;
      case 'line':   drawLine(obj, highlight);   break;
      case 'rect':   drawRect(obj, highlight);   break;
      case 'circle': drawCircle(obj, highlight); break;
      case 'text':   drawText(obj, highlight);   break;
    }
    ctx.restore();
  }

  function drawStroke(o, hi) {
    if (!o.points || o.points.length < 2) return;
    ctx.lineCap  = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle  = o.color;
    ctx.lineWidth    = o.width;
    ctx.globalAlpha  = o.opacity || 1;
    ctx.beginPath();
    ctx.moveTo(o.points[0].x, o.points[0].y);
    for (let i = 1; i < o.points.length; i++) ctx.lineTo(o.points[i].x, o.points[i].y);
    ctx.stroke();
    ctx.globalAlpha  = 1;
  }

  function drawLine(o, hi) {
    ctx.lineCap   = 'round';
    ctx.strokeStyle = o.color;
    ctx.lineWidth   = o.width;
    ctx.beginPath();
    ctx.moveTo(o.x1, o.y1);
    ctx.lineTo(o.x2, o.y2);
    ctx.stroke();
  }

  function drawRect(o, hi) {
    ctx.lineCap   = 'round';
    ctx.lineJoin  = 'round';
    ctx.strokeStyle = o.color;
    ctx.lineWidth   = o.width;
    ctx.strokeRect(o.x, o.y, o.w, o.h);
  }

  function drawCircle(o, hi) {
    ctx.lineCap   = 'round';
    ctx.strokeStyle = o.color;
    ctx.lineWidth   = o.width;
    ctx.beginPath();
    ctx.ellipse(o.cx, o.cy, Math.abs(o.rx), Math.abs(o.ry), 0, 0, Math.PI * 2);
    ctx.stroke();
  }

  function drawText(o, hi) {
    ctx.font      = '500 ' + o.fontSize + 'px Inter, sans-serif';
    ctx.fillStyle = o.color;
    ctx.globalAlpha = 1;
    ctx.globalCompositeOperation = 'source-over';
    const lines = (o.content || '').split('\n');
    lines.forEach((line, i) => ctx.fillText(line, o.x, o.y + i * o.fontSize * 1.35));
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     SELECTION OVERLAY  (drawn in screen coords, no transform)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function getObjById(id) { return objects.find(o => o.id === id); }

  function getBounds(obj) {
    // Returns worldâ€space bounding box {x,y,w,h}
    switch (obj.type) {
      case 'stroke': {
        const xs = obj.points.map(p => p.x), ys = obj.points.map(p => p.y);
        const mn = (a) => Math.min(...a), mx = (a) => Math.max(...a);
        return { x:mn(xs)-obj.width/2, y:mn(ys)-obj.width/2, w:mx(xs)-mn(xs)+obj.width, h:mx(ys)-mn(ys)+obj.width };
      }
      case 'line':   return { x:Math.min(obj.x1,obj.x2)-obj.width/2, y:Math.min(obj.y1,obj.y2)-obj.width/2, w:Math.abs(obj.x2-obj.x1)+obj.width, h:Math.abs(obj.y2-obj.y1)+obj.width };
      case 'rect':   return { x:Math.min(obj.x,obj.x+obj.w), y:Math.min(obj.y,obj.y+obj.h), w:Math.abs(obj.w), h:Math.abs(obj.h) };
      case 'circle': return { x:obj.cx-Math.abs(obj.rx), y:obj.cy-Math.abs(obj.ry), w:Math.abs(obj.rx)*2, h:Math.abs(obj.ry)*2 };
      case 'text':   {
        ctx.font = '500 ' + obj.fontSize + 'px Inter, sans-serif';
        const lines = (obj.content||'').split('\n');
        const mw = Math.max(...lines.map(l => ctx.measureText(l).width));
        return { x:obj.x, y:obj.y - obj.fontSize, w: mw || 80, h: lines.length * obj.fontSize * 1.35 };
      }
      default: return { x:0,y:0,w:0,h:0 };
    }
  }

  // Returns 8 handle descriptors [{ id, wx, wy }] in world coords
  function getHandles(obj) {
    const b = getBounds(obj);
    const cx = b.x + b.w/2, cy = b.y + b.h/2;
    return [
      { id:'nw', wx:b.x,      wy:b.y      },
      { id:'n',  wx:cx,       wy:b.y      },
      { id:'ne', wx:b.x+b.w,  wy:b.y      },
      { id:'e',  wx:b.x+b.w,  wy:cy       },
      { id:'se', wx:b.x+b.w,  wy:b.y+b.h  },
      { id:'s',  wx:cx,       wy:b.y+b.h  },
      { id:'sw', wx:b.x,      wy:b.y+b.h  },
      { id:'w',  wx:b.x,      wy:cy       },
    ];
  }

  // Cursor for resize handle
  function handleCursor(id) {
    return { nw:'nw-resize', ne:'ne-resize', sw:'sw-resize', se:'se-resize',
             n:'n-resize', s:'s-resize', e:'e-resize', w:'w-resize' }[id] || 'crosshair';
  }

  function drawSelectionOverlay() {
    const obj = getObjById(selectedId);
    if (!obj) return;
    const b = getBounds(obj);
    // bounding rect in screen coords
    const tl = w2s(b.x,      b.y);
    const br = w2s(b.x+b.w,  b.y+b.h);
    const sw = br.x - tl.x, sh = br.y - tl.y;

    ctx.save();
    // Selection outline
    ctx.strokeStyle = '#2563EB';
    ctx.lineWidth   = 1.5;
    ctx.setLineDash([5, 4]);
    ctx.strokeRect(tl.x - 1, tl.y - 1, sw + 2, sh + 2);
    ctx.setLineDash([]);

    // Handles
    getHandles(obj).forEach(h => {
      const sp = w2s(h.wx, h.wy);
      ctx.fillStyle   = '#fff';
      ctx.strokeStyle = '#2563EB';
      ctx.lineWidth   = 1.5;
      ctx.beginPath();
      ctx.arc(sp.x, sp.y, HANDLE_R, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
    });
    ctx.restore();
  }

  // Returns handle id if (sx,sy) is within a handle, else null
  function hitHandle(sx, sy, obj) {
    for (const h of getHandles(obj)) {
      const sp = w2s(h.wx, h.wy);
      if (Math.hypot(sx - sp.x, sy - sp.y) <= HANDLE_R + 3) return h.id;
    }
    return null;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     HIT TESTING
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function hitTest(wx, wy) {
    // Iterate in reverse (top-most first)
    for (let i = objects.length - 1; i >= 0; i--) {
      if (hitObject(objects[i], wx, wy)) return objects[i].id;
    }
    return null;
  }

  function hitObject(obj, wx, wy) {
    const t = HIT_THRESH / cam.scale;  // hit threshold in world coords
    switch (obj.type) {
      case 'stroke': {
        const pts = obj.points;
        for (let i = 1; i < pts.length; i++) {
          if (distPtSeg(wx, wy, pts[i-1].x, pts[i-1].y, pts[i].x, pts[i].y) < t + obj.width/2) return true;
        }
        return false;
      }
      case 'line':   return distPtSeg(wx, wy, obj.x1, obj.y1, obj.x2, obj.y2) < t + obj.width/2;
      case 'rect':   { const b = getBounds(obj); return wx>=b.x-t && wx<=b.x+b.w+t && wy>=b.y-t && wy<=b.y+b.h+t; }
      case 'circle': { const dx=(wx-obj.cx)/Math.abs(obj.rx||1), dy=(wy-obj.cy)/Math.abs(obj.ry||1); const d=Math.sqrt(dx*dx+dy*dy); return Math.abs(d-1) < t/Math.max(Math.abs(obj.rx||1),1); }
      case 'text':   { const b = getBounds(obj); return wx>=b.x-t && wx<=b.x+b.w+t && wy>=b.y-t && wy<=b.y+b.h+t; }
      default: return false;
    }
  }

  function distPtSeg(px, py, ax, ay, bx, by) {
    const dx = bx-ax, dy = by-ay;
    const len2 = dx*dx + dy*dy;
    if (len2 === 0) return Math.hypot(px-ax, py-ay);
    const t = Math.max(0, Math.min(1, ((px-ax)*dx + (py-ay)*dy) / len2));
    return Math.hypot(px - (ax + t*dx), py - (ay + t*dy));
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     OBJECT MUTATION (for resize)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function applyResize(obj, handleId, dwx, dwy) {
    switch (obj.type) {
      case 'line': {
        if (handleId === 'nw' || handleId === 'w' || handleId === 'sw') { obj.x1 += dwx; obj.y1 += dwy; }
        else { obj.x2 += dwx; obj.y2 += dwy; }
        break;
      }
      case 'rect': {
        const b0 = { x:obj.x, y:obj.y, w:obj.w, h:obj.h };
        if (handleId.includes('n')) { obj.y = b0.y + dwy; obj.h = b0.h - dwy; }
        if (handleId.includes('s')) { obj.h = b0.h + dwy; }
        if (handleId.includes('w')) { obj.x = b0.x + dwx; obj.w = b0.w - dwx; }
        if (handleId.includes('e')) { obj.w = b0.w + dwx; }
        break;
      }
      case 'circle': {
        if (handleId.includes('e') || handleId.includes('w')) obj.rx += (handleId.includes('e') ? dwx : -dwx) / 2;
        if (handleId.includes('n') || handleId.includes('s')) obj.ry += (handleId.includes('s') ? dwy : -dwy) / 2;
        break;
      }
      default: break; // strokes / text: no resize
    }
  }

  function moveObject(obj, dwx, dwy) {
    switch (obj.type) {
      case 'stroke': obj.points = obj.points.map(p => ({ x: p.x+dwx, y: p.y+dwy })); break;
      case 'line':   obj.x1+=dwx; obj.y1+=dwy; obj.x2+=dwx; obj.y2+=dwy; break;
      case 'rect':   obj.x+=dwx; obj.y+=dwy; break;
      case 'circle': obj.cx+=dwx; obj.cy+=dwy; break;
      case 'text':   obj.x+=dwx; obj.y+=dwy; break;
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     POINTER EVENTS  â€” Mouse & Touch
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  canvasArea.addEventListener('mousedown',   onDown);
  canvasArea.addEventListener('mousemove',   onMove);
  canvasArea.addEventListener('mouseup',     onUp);
  canvasArea.addEventListener('mouseleave',  onLeave);
  canvasArea.addEventListener('dblclick',    onDblClick);
  canvasArea.addEventListener('wheel',       onWheel, { passive: false });
  canvasArea.addEventListener('touchstart',  onTouchStart, { passive: false });
  canvasArea.addEventListener('touchmove',   onTouchMove,  { passive: false });
  canvasArea.addEventListener('touchend',    onTouchEnd,   { passive: false });

  let lastTouchDist = 0;

  function onTouchStart(e) {
    e.preventDefault();
    if (e.touches.length === 2) {
      lastTouchDist = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      return;
    }
    onDown(e.touches[0]);
  }
  function onTouchMove(e) {
    e.preventDefault();
    if (e.touches.length === 2) {
      const d = Math.hypot(
        e.touches[0].clientX - e.touches[1].clientX,
        e.touches[0].clientY - e.touches[1].clientY
      );
      const r  = canvasArea.getBoundingClientRect();
      const mx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - r.left;
      const my = (e.touches[0].clientY + e.touches[1].clientY) / 2 - r.top;
      applyZoom(d / lastTouchDist, mx, my);
      lastTouchDist = d;
      return;
    }
    onMove(e.touches[0]);
  }
  function onTouchEnd(e) { e.preventDefault(); onUp(e); }

  function onDown(e) {
    if (textEditor) { commitTextEdit(); return; }
    const { sx, sy } = evPos(e);
    const wPos = s2w(sx, sy);

    // â”€â”€ PAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const wantsPin = spaceHeld || e.button === 1 || tool === 'pan';
    if (wantsPin) {
      iState = 'panning';
      panOrigin = { mx: sx, my: sy, cx: cam.x, cy: cam.y };
      setCursor('grabbing');
      return;
    }

    // â”€â”€ SELECT tool â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (tool === 'select') {
      // Check resize handle first
      if (selectedId !== null && !selIsSicky) {
        const obj = getObjById(selectedId);
        if (obj) {
          const h = hitHandle(sx, sy, obj);
          if (h) {
            iState = 'resizing';
            resizeHandle  = h;
            resizeOrigin  = { mx:sx, my:sy, snapshotJSON: JSON.stringify(obj) };
            setCursor(handleCursor(h));
            return;
          }
        }
      }
      // Check object hit
      const hitId = hitTest(wPos.x, wPos.y);
      if (hitId !== null) {
        selectedId = hitId;
        selIsSicky = false;
        const obj = getObjById(hitId);
        const b = getBounds(obj);
        iState = 'dragging';
        moveOrigin = { mx: sx, my: sy, owx: wPos.x - b.x, owy: wPos.y - b.y };
        setCursor('move');
      } else {
        selectedId = null;
        iState = 'idle';
        setCursor('default');
      }
      schedRender();
      return;
    }

    // â”€â”€ ERASER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (tool === 'eraser') {
      eraseAt(wPos.x, wPos.y);
      iState = 'drawing';  // reuse to keep erasing on move
      return;
    }

    // â”€â”€ PEN / HIGHLIGHTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (tool === 'pen' || tool === 'highlighter') {
      iState = 'drawing';
      liveStroke = {
        id: null, type: 'stroke',
        points: [{ x: wPos.x, y: wPos.y }],
        color, width: brushSize, opacity: tool === 'highlighter' ? 0.42 : 1
      };
      return;
    }

    // â”€â”€ SHAPES + LINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (['line','rect','circle'].includes(tool)) {
      iState = 'drawing';
      drawOrigin = { wx: wPos.x, wy: wPos.y };
      previewObj = makeShape(tool, wPos.x, wPos.y, wPos.x, wPos.y);
      return;
    }

    // â”€â”€ TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (tool === 'text') {
      openTextEditor(null, sx, sy, wPos.x, wPos.y);
      return;
    }
  }

  function onMove(e) {
    const { sx, sy } = evPos(e);
    const wPos = s2w(sx, sy);

    if (iState === 'panning') {
      cam.x = panOrigin.cx + (sx - panOrigin.mx);
      cam.y = panOrigin.cy + (sy - panOrigin.my);
      syncGridBg();
      schedRender();
      return;
    }

    if (iState === 'drawing') {
      if (tool === 'eraser') { eraseAt(wPos.x, wPos.y); return; }
      if (liveStroke) {
        liveStroke.points.push({ x: wPos.x, y: wPos.y });
        schedRender();
      }
      if (previewObj && drawOrigin) {
        previewObj = makeShape(tool, drawOrigin.wx, drawOrigin.wy, wPos.x, wPos.y);
        schedRender();
      }
      return;
    }

    if (iState === 'dragging') {
      const obj = getObjById(selectedId);
      if (!obj) return;
      const b  = getBounds(obj);
      const nwx = wPos.x - moveOrigin.owx;
      const nwy = wPos.y - moveOrigin.owy;
      moveObject(obj, nwx - b.x, nwy - b.y);
      schedRender();
      return;
    }

    if (iState === 'resizing') {
      const obj = getObjById(selectedId);
      if (!obj) return;
      const dwx = (sx - resizeOrigin.mx) / cam.scale;
      const dwy = (sy - resizeOrigin.my) / cam.scale;
      // Restore + re-apply delta fresh each move
      const snap = JSON.parse(resizeOrigin.snapshotJSON);
      Object.assign(obj, snap);
      applyResize(obj, resizeHandle, dwx, dwy);
      schedRender();
      return;
    }

    // Hover cursor update for select tool
    if (tool === 'select') {
      if (selectedId !== null && !selIsSicky) {
        const obj = getObjById(selectedId);
        if (obj) {
          const h = hitHandle(sx, sy, obj);
          if (h) { setCursor(handleCursor(h)); return; }
        }
      }
      const hitId = hitTest(wPos.x, wPos.y);
      setCursor(hitId !== null ? 'move' : 'default');
    }
  }

  function onUp(e) {
    if (iState === 'panning') {
      iState = 'idle';
      setCursor(spaceHeld ? 'grab' : toolCursor());
      return;
    }
    if (iState === 'drawing') {
      if (liveStroke && liveStroke.points.length >= 2) {
        liveStroke.id = objSeq++;
        objects.push(liveStroke);
        pushHistory(); saveToStorage();
      }
      liveStroke = null;
      if (previewObj && drawOrigin) {
        const wp  = evWorld(e);
        const fin = makeShape(tool, drawOrigin.wx, drawOrigin.wy, wp.x, wp.y);
        fin.id = objSeq++;
        objects.push(fin);
        selectedId = fin.id; selIsSicky = false;
        previewObj = null; drawOrigin = null;
        pushHistory(); saveToStorage();
      }
    }
    if (iState === 'dragging' || iState === 'resizing') {
      pushHistory(); saveToStorage();
    }
    iState = 'idle';
    setCursor(toolCursor());
    schedRender();
  }

  function onLeave(e) { if (iState !== 'idle') onUp(e); }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     DOUBLE CLICK â€” text edit
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function onDblClick(e) {
    const { sx, sy } = evPos(e);
    const wPos = s2w(sx, sy);
    const hitId = hitTest(wPos.x, wPos.y);
    if (hitId !== null) {
      const obj = getObjById(hitId);
      if (obj && obj.type === 'text') {
        openTextEditor(obj, sx, sy, obj.x, obj.y);
      }
    } else if (tool === 'text') {
      openTextEditor(null, sx, sy, wPos.x, wPos.y);
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ZOOM
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function onWheel(e) {
    e.preventDefault();
    const r  = canvasArea.getBoundingClientRect();
    const sx = e.clientX - r.left, sy = e.clientY - r.top;
    applyZoom(e.deltaY < 0 ? 1.1 : 0.909, sx, sy);
  }

  function applyZoom(factor, sx, sy) {
    const ns = Math.max(0.05, Math.min(20, cam.scale * factor));
    const f  = ns / cam.scale;
    cam.x = sx - (sx - cam.x) * f;
    cam.y = sy - (sy - cam.y) * f;
    cam.scale = ns;
    syncGridBg();
    schedRender();
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ERASER
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function eraseAt(wx, wy) {
    const t = (brushSize * 3) / cam.scale;
    const before = objects.length;
    objects = objects.filter(o => !hitObjectRadius(o, wx, wy, t));
    if (objects.length !== before) {
      if (selectedId !== null && !getObjById(selectedId)) selectedId = null;
      schedRender(); saveToStorage();
    }
  }

  function hitObjectRadius(obj, wx, wy, r) {
    const b = getBounds(obj);
    const cx = b.x + b.w/2, cy = b.y + b.h/2;
    return Math.hypot(wx - cx, wy - cy) < r + Math.max(b.w, b.h) / 2;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     SHAPE FACTORY
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function makeShape(t, x1, y1, x2, y2) {
    const base = { id: null, color, width: brushSize };
    if (t === 'line')   return { ...base, type:'line', x1, y1, x2, y2 };
    if (t === 'rect')   return { ...base, type:'rect', x:x1, y:y1, w:x2-x1, h:y2-y1 };
    if (t === 'circle') return { ...base, type:'circle', cx:(x1+x2)/2, cy:(y1+y2)/2, rx:Math.abs(x2-x1)/2, ry:Math.abs(y2-y1)/2 };
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     INLINE TEXT EDITOR
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function openTextEditor(existingObj, sx, sy, wx, wy) {
    cancelTextEdit();
    editingId = existingObj ? existingObj.id : null;

    const fsize = Math.max(13, brushSize * 4);
    const r     = canvasArea.getBoundingClientRect();

    // Position textarea at screen coords of the world point
    const sp = existingObj ? w2s(existingObj.x, existingObj.y - existingObj.fontSize) : { x: sx, y: sy };

    textEditor = document.createElement('textarea');
    textEditor.value = existingObj ? existingObj.content : '';
    Object.assign(textEditor.style, {
      position:   'fixed',
      left:       (r.left + sp.x) + 'px',
      top:        (r.top  + sp.y) + 'px',
      minWidth:   '180px',
      minHeight:  '48px',
      fontSize:   Math.round(fsize * cam.scale) + 'px',
      fontFamily: 'Inter, sans-serif',
      fontWeight: '500',
      color:      color,
      background: 'var(--surface)',
      border:     '2px solid var(--clr-primary, #2563EB)',
      borderRadius: '10px',
      padding:    '8px 12px',
      resize:     'both',
      zIndex:     '99998',
      outline:    'none',
      boxShadow:  '0 4px 20px rgba(37,99,235,.25)',
      lineHeight: '1.45',
    });
    textEditor.placeholder = 'Typeâ€¦ Enter = new line, Shift+Enter = place, Esc = cancel';
    textEditor.__wx = wx; textEditor.__wy = wy;

    document.body.appendChild(textEditor);
    textEditor.focus();
    textEditor.select();

    textEditor.addEventListener('keydown', ke => {
      if (ke.key === 'Escape')                      { cancelTextEdit(); }
      if (ke.key === 'Enter' && ke.shiftKey)        { ke.preventDefault(); commitTextEdit(); }
    });
    textEditor.addEventListener('blur', () => setTimeout(commitTextEdit, 80));
  }

  function commitTextEdit() {
    if (!textEditor) return;
    const val = textEditor.value.trim();
    const wx  = textEditor.__wx;
    const wy  = textEditor.__wy;
    const fsize = Math.max(13, brushSize * 4);
    const te  = textEditor;
    textEditor = null;
    te.remove();

    if (!val) { editingId = null; return; }

    if (editingId !== null) {
      const obj = getObjById(editingId);
      if (obj) { obj.content = val; obj.color = color; }
    } else {
      objects.push({ id: objSeq++, type:'text', x:wx, y:wy, content:val, color, fontSize:fsize });
    }
    editingId = null;
    pushHistory(); saveToStorage(); schedRender();
  }

  function cancelTextEdit() {
    if (!textEditor) return;
    const te = textEditor;
    textEditor = null;
    editingId  = null;
    te.remove();
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     TOOL BAR WIRING
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  toolBtns.forEach(btn => btn.addEventListener('click', () => setTool(btn.dataset.tool)));

  function setTool(t) {
    cancelTextEdit();
    tool = t;
    toolBtns.forEach(b => b.classList.toggle('active', b.dataset.tool === t));
    setCursor(toolCursor());
    toolNameEl.textContent = TOOL_LABELS[t] || t;
  }

  function toolCursor() {
    if (spaceHeld) return 'grab';
    switch (tool) {
      case 'select':      return 'default';
      case 'eraser':      return 'cell';
      case 'text':        return 'text';
      case 'pen':
      case 'highlighter':
      case 'line':
      case 'rect':
      case 'circle':      return 'crosshair';
      default:            return 'default';
    }
  }

  function setCursor(cur) {
    canvasArea.style.cursor = cur;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     COLOUR PALETTE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildPalette() {
    paletteGrid.innerHTML = '';
    PAL_COLORS.forEach(c => {
      const sw = document.createElement('button');
      sw.className = 'wb-pal-swatch';
      sw.style.background = c;
      sw.addEventListener('click', () => { setColor(c); paletteEl.classList.remove('open'); });
      paletteGrid.appendChild(sw);
    });
  }

  function setColor(c) {
    color = c;
    colorSwatch.style.background = c;
    customColorEl.value = c;
    // Update selected object colour
    if (selectedId !== null) {
      const obj = getObjById(selectedId);
      if (obj) {
        if ('color' in obj) obj.color = c;
        pushHistory(); saveToStorage(); schedRender();
      }
    }
  }

  colorSwatch.addEventListener('click', e => {
    e.stopPropagation();
    const rect = colorSwatch.getBoundingClientRect();
    paletteEl.style.top  = (rect.bottom + 8) + 'px';
    paletteEl.style.left = rect.left + 'px';
    paletteEl.classList.toggle('open');
  });

  document.addEventListener('click', e => {
    if (!paletteEl.contains(e.target) && e.target !== colorSwatch)
      paletteEl.classList.remove('open');
  });
  customColorEl.addEventListener('input', () => setColor(customColorEl.value));

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     SIZE SLIDER
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  sizeSlider.addEventListener('input', () => {
    brushSize = parseInt(sizeSlider.value, 10);
    sizeVal.textContent = brushSize;
    // Apply to selected object
    if (selectedId !== null) {
      const obj = getObjById(selectedId);
      if (obj && 'width' in obj) {
        obj.width = brushSize;
        pushHistory(); saveToStorage(); schedRender();
      }
    }
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     GRID BACKGROUND SYNC
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function syncGridBg() {
    const gs = 40 * cam.scale;
    canvasArea.style.backgroundSize     = gs + 'px ' + gs + 'px';
    canvasArea.style.backgroundPosition = (cam.x % gs) + 'px ' + (cam.y % gs) + 'px';
  }

  function syncStickyLayer() {
    stickyLayer.style.transform = `matrix(${cam.scale},0,0,${cam.scale},${cam.x},${cam.y})`;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     OPEN / CLOSE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  openBtn.addEventListener('click', openWB);
  closeBtn.addEventListener('click', closeWB);

  function openWB() {
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
    setTimeout(() => {
      if (!initialized) {
        initialized = true;
        resizeCanvas();
        buildPalette();
        setTool('select');
        loadFromStorage();
        if (history.length === 0) pushHistory();
        syncGridBg();
        syncStickyLayer();
      } else {
        resizeCanvas();
        syncGridBg();
        syncStickyLayer();
        schedRender();
      }
    }, 40);
  }

  function closeWB() {
    overlay.classList.remove('open');
    document.body.style.overflow = '';
    cancelTextEdit();
  }

  window.addEventListener('resize', () => {
    if (overlay.classList.contains('open')) resizeCanvas();
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UNDO / REDO
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  undoBtn.addEventListener('click', undo);
  redoBtn.addEventListener('click', redo);

  function pushHistory() {
    history = history.slice(0, histIdx + 1);
    history.push({
      objects:  deepClone(objects),
      stickies: deepClone(stickies),
      cam: { ...cam },
    });
    if (history.length > MAX_HIST) history.shift();
    histIdx = history.length - 1;
    updateUndoRedo();
  }

  function applySnapshot(snap) {
    objects  = deepClone(snap.objects);
    stickies = deepClone(snap.stickies);
    cam      = { ...snap.cam };
    selectedId = null;
    renderAllStickies();
    syncGridBg();
    schedRender();
    updateUI();
  }

  function undo() { if (histIdx > 0)  applySnapshot(history[--histIdx]); updateUndoRedo(); }
  function redo() { if (histIdx < history.length-1) applySnapshot(history[++histIdx]); updateUndoRedo(); }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     CLEAR
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  clearBtn.addEventListener('click', () => {
    if (!confirm('Clear the entire board? All drawings and notes will be removed.')) return;
    objects  = []; stickies = [];
    selectedId = null;
    cam = { x:0, y:0, scale:1 };
    stickyLayer.innerHTML = '';
    syncGridBg(); schedRender(); pushHistory(); saveToStorage(); updateUI();
    showToast('Board cleared');
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     DELETE SELECTED
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function deleteSelected() {
    if (selectedId === null) return;
    if (selIsSicky) {
      deleteSticky(selectedId);
    } else {
      objects = objects.filter(o => o.id !== selectedId);
      selectedId = null;
      pushHistory(); saveToStorage(); schedRender();
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     SAVE / LOAD (localStorage)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  saveBtn.addEventListener('click', () => { saveToStorage(); showToast('Saved to browser âœ“'); });

  function saveToStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ objects, stickies, cam, color, brushSize, tool }));
    } catch (_) { /* quota */ }
  }

  function loadFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const d = JSON.parse(raw);
      if (d.objects)  objects  = d.objects;
      if (d.stickies) stickies = d.stickies;
      if (d.cam)      Object.assign(cam, d.cam);
      if (d.color)    setColor(d.color);
      if (d.brushSize){ brushSize = d.brushSize; sizeSlider.value = brushSize; sizeVal.textContent = brushSize; }
      if (d.tool)     setTool(d.tool);
      if (stickies.length) {
        stickySeq = Math.max(...stickies.map(s => s.id), 0) + 1;
        renderAllStickies();
      }
      if (objects.length) objSeq = Math.max(...objects.map(o => o.id), 0) + 1;
      pushHistory();
    } catch (_) { /* ignore */ }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     EXPORT PNG
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  exportBtn.addEventListener('click', exportPNG);

  function exportPNG() {
    const W = canvasArea.clientWidth, H = canvasArea.clientHeight;
    const off = document.createElement('canvas');
    off.width = W; off.height = H;
    const oc  = off.getContext('2d');
    const dk  = document.documentElement.getAttribute('data-theme') === 'dark';

    oc.fillStyle = dk ? '#0B1120' : '#F0F4F8';
    oc.fillRect(0, 0, W, H);

    // Grid
    const gs = 40 * cam.scale, ox = cam.x % gs, oy = cam.y % gs;
    oc.strokeStyle = dk ? 'rgba(148,163,184,.07)' : 'rgba(100,116,139,.1)';
    oc.lineWidth = 1;
    for (let x = ox; x < W; x += gs) { oc.beginPath(); oc.moveTo(x,0); oc.lineTo(x,H); oc.stroke(); }
    for (let y = oy; y < H; y += gs) { oc.beginPath(); oc.moveTo(0,y); oc.lineTo(W,y); oc.stroke(); }

    // Canvas content
    oc.drawImage(canvas, 0, 0, W, H);

    // Stickies
    stickies.forEach(s => {
      const sx = s.x * cam.scale + cam.x, sy = s.y * cam.scale + cam.y;
      const sw = s.w * cam.scale, sh = s.h * cam.scale;
      const pal = STICKY_PALETTES[s.colorIdx % STICKY_PALETTES.length];
      oc.fillStyle = pal.bg;
      roundRect(oc, sx, sy, sw, sh, 12); oc.fill();
      oc.fillStyle = pal.hd;
      roundRect(oc, sx, sy, sw, Math.min(28 * cam.scale, sh * .3), 12); oc.fill();
      const fs = Math.max(9, 13 * cam.scale);
      oc.font = `normal ${fs}px Inter, sans-serif`;
      oc.fillStyle = 'rgba(0,0,0,.72)';
      (s.text||'').split('\n').forEach((ln, i) =>
        oc.fillText(ln, sx + 10*cam.scale, sy + 36*cam.scale + i*fs*1.4, sw - 18*cam.scale));
    });

    const a = document.createElement('a');
    a.download = 'whiteboard-san.png';
    a.href = off.toDataURL('image/png');
    a.click();
    showToast('PNG exported â†“');
  }

  function roundRect(c, x, y, w, h, r) {
    c.beginPath(); c.roundRect(x, y, w, h, r);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     STICKY NOTES
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  addStickyBtn.addEventListener('click', () => {
    const wp = s2w(canvasArea.clientWidth / 2, canvasArea.clientHeight / 2);
    addSticky(wp.x - 95, wp.y - 70, 0);
  });

  function addSticky(wx, wy, colorIdx) {
    const s = { id: stickySeq++, x:wx, y:wy, w:190, h:150, text:'', colorIdx, zIdx: stickySeq };
    stickies.push(s);
    createStickyEl(s);
    pushHistory(); saveToStorage(); updateUI();
  }

  function renderAllStickies() {
    stickyLayer.innerHTML = '';
    stickies.forEach(s => createStickyEl(s));
    updateUI();
  }

  function createStickyEl(s) {
    const pal = STICKY_PALETTES[s.colorIdx % STICKY_PALETTES.length];
    const el  = document.createElement('div');
    el.className  = 'sticky-note';
    el.dataset.id = s.id;
    el.style.cssText = `left:${s.x}px;top:${s.y}px;width:${s.w}px;height:${s.h}px;background:${pal.bg};z-index:${s.zIdx};`;

    const hd = document.createElement('div');
    hd.className = 'sticky-header';
    hd.style.background = pal.hd;

    const dots = document.createElement('div');
    dots.className = 'sticky-color-dots';
    STICKY_PALETTES.forEach((p, i) => {
      const d = document.createElement('button');
      d.className = 'sticky-color-dot';
      d.style.background = p.hd;
      if (i === s.colorIdx) d.style.outline = '2px solid rgba(0,0,0,.4)';
      d.addEventListener('click', ev => { ev.stopPropagation(); changeStickyColor(s.id, i); });
      dots.appendChild(d);
    });

    const del = document.createElement('button');
    del.className = 'sticky-del-btn';
    del.innerHTML = '&times;';
    del.addEventListener('click', ev => { ev.stopPropagation(); deleteSticky(s.id); });

    hd.appendChild(dots); hd.appendChild(del);

    const ta = document.createElement('textarea');
    ta.className   = 'sticky-text';
    ta.placeholder = 'Type a noteâ€¦';
    ta.value       = s.text || '';
    ta.addEventListener('input', () => { s.text = ta.value; saveToStorage(); });
    ta.addEventListener('mousedown', ev => ev.stopPropagation());
    ta.addEventListener('touchstart', ev => ev.stopPropagation(), { passive: true });

    const rh = document.createElement('div');
    rh.className = 'sticky-resize';
    rh.addEventListener('mousedown', ev => { ev.stopPropagation(); startStickyResize(ev, s, el); });

    el.appendChild(hd); el.appendChild(ta); el.appendChild(rh);
    stickyLayer.appendChild(el);

    hd.addEventListener('mousedown', ev => { ev.stopPropagation(); startStickyDrag(ev, s, el); });
    hd.addEventListener('touchstart', ev => { ev.stopPropagation(); startStickyDrag(ev.touches[0], s, el); }, { passive: false });

    el.addEventListener('mousedown', ev => {
      selectedId = s.id; selIsSicky = true;
    });
  }

  function startStickyDrag(e, s, el) {
    const aR = canvasArea.getBoundingClientRect();
    const offX = (e.clientX - aR.left) / cam.scale - cam.x / cam.scale - s.x;
    const offY = (e.clientY - aR.top)  / cam.scale - cam.y / cam.scale - s.y;
    s.zIdx = stickySeq++; el.style.zIndex = s.zIdx;

    function move(me) {
      const x = (me.clientX - aR.left) / cam.scale - cam.x / cam.scale - offX;
      const y = (me.clientY - aR.top)  / cam.scale - cam.y / cam.scale - offY;
      s.x = x; s.y = y;
      el.style.left = x + 'px'; el.style.top = y + 'px';
    }
    function up() {
      document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up);
      document.removeEventListener('touchmove', tmove); document.removeEventListener('touchend', up);
      pushHistory(); saveToStorage();
    }
    function tmove(te) { move(te.touches[0]); }
    document.addEventListener('mousemove', move); document.addEventListener('mouseup', up);
    document.addEventListener('touchmove', tmove); document.addEventListener('touchend', up);
  }

  function startStickyResize(e, s, el) {
    const s0w = s.w, s0h = s.h, m0x = e.clientX, m0y = e.clientY;
    function move(me) {
      s.w = Math.max(150, s0w + (me.clientX - m0x) / cam.scale);
      s.h = Math.max(110, s0h + (me.clientY - m0y) / cam.scale);
      el.style.width  = s.w + 'px';
      el.style.height = s.h + 'px';
    }
    function up() {
      document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up);
      pushHistory(); saveToStorage();
    }
    document.addEventListener('mousemove', move); document.addEventListener('mouseup', up);
  }

  function changeStickyColor(id, colorIdx) {
    const s = stickies.find(n => n.id === id); if (!s) return;
    s.colorIdx = colorIdx;
    const el = stickyLayer.querySelector(`[data-id="${id}"]`);
    if (el) el.remove();
    createStickyEl(s);
    pushHistory(); saveToStorage();
  }

  function deleteSticky(id) {
    stickies = stickies.filter(s => s.id !== id);
    const el = stickyLayer.querySelector(`[data-id="${id}"]`);
    if (el) el.remove();
    if (selectedId === id) selectedId = null;
    pushHistory(); saveToStorage(); updateUI();
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     KEYBOARD SHORTCUTS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  document.addEventListener('keydown', e => {
    if (!overlay.classList.contains('open')) return;
    const tag = document.activeElement.tagName;
    if (tag === 'TEXTAREA' || tag === 'INPUT') return;

    if (e.code === 'Space')  { e.preventDefault(); spaceHeld = true;  setCursor('grab'); return; }
    if (e.key  === 'Escape') { closeWB(); return; }

    if (e.ctrlKey || e.metaKey) {
      if   (e.key === 'z' && !e.shiftKey) { e.preventDefault(); undo(); }
      else if (e.key === 'z' || e.key === 'y') { e.preventDefault(); redo(); }
      else if (e.key === 's') { e.preventDefault(); saveToStorage(); showToast('Saved âœ“'); }
      else if (e.key === 'e') { e.preventDefault(); exportPNG(); }
      return;
    }

    const tmap = { v:'select', p:'pen', h:'highlighter', e:'eraser', l:'line', r:'rect', c:'circle', t:'text' };
    if (tmap[e.key.toLowerCase()]) { setTool(tmap[e.key.toLowerCase()]); return; }
    if (e.key.toLowerCase() === 'n') { addStickyBtn.click(); return; }

    if (e.key === 'Delete' || e.key === 'Backspace') deleteSelected();
    if (e.key === '0' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      cam = { x:0, y:0, scale:1 }; syncGridBg(); schedRender();
    }
  });

  document.addEventListener('keyup', e => {
    if (e.code === 'Space') { spaceHeld = false; setCursor(toolCursor()); }
  });

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UI HELPERS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateZoomUI() {
    zoomPctEl.textContent = Math.round(cam.scale * 100) + '%';
  }
  function updateUndoRedo() {
    undoBtn.disabled = histIdx <= 0;
    redoBtn.disabled = histIdx >= history.length - 1;
  }
  function updateUI() {
    itemCountEl.textContent = stickies.length;
    toolNameEl.textContent  = TOOL_LABELS[tool] || tool;
    updateUndoRedo();
  }

  let toastTm;
  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    clearTimeout(toastTm);
    toastTm = setTimeout(() => toastEl.classList.remove('show'), 2400);
  }

  function deepClone(o) { return JSON.parse(JSON.stringify(o)); }

})();
</script>
</body>
</html>
